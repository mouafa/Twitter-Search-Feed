/**
 * Copyright (c) 2011 Ken Colton
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * License available in GPL-LICENSE.txt or <http://www.gnu.org/licenses/>.
 */
function TwitterSearchFeed(a){var b=this;b.options={viewportHeight:500,updateSecs:30,minDelaySecs:2,userId:null};b.options=$.extend(b.options,a);b.$node=b.options.$node;b.$status=b.$node.find(".TwitterSearchFeed_status");b.feed=new Feed(b)}function Feed(a){var b=this;b.parent=a;b.options=a.options;b.reachedBottom=false;b.searchSinceId=null;b.searchMaxId=null;b.searchInProgress=false;b.updateTimeout=null;b.api=new TwitterSearch;b.view=new FeedView(b);b.buffer=new FeedBuffer(b);b.init()}function FeedBuffer(a){var b=this;b.parent=a;b.options=a.options;b.maxTweets=b.options.updateSecs/b.options.minDelaySecs;b.tweets=[];b.timeout=null;b.processRateSecs=null}function FeedView(a){var b=this;b.parent=a;b.options=a.options;b.$node=b.options.$node;b.$fade=null;b.$viewport=null;b.$feed=null;b.construct()}function Tweet(a,b){var c=this;c.parent=a;c.options=a.options;c.data=b;c.$node=null}function TwitterSearchRequest(a,b,c,d){var e=this;e.search=a;e.successCallback=b;e.failureCallback=c;e.failureTimeout=null;e.options=d}function TwitterSearch(){var a=this;a.rateLimitSecs=5;a.requestQueue=[];a.processTimeout=null;a.lastSearchTime=null}function prettyDate(a){var b=new Date((a||"").replace(/-/g,"/").replace(/[TZ]/g," ")),c=((new Date).getTime()-b.getTime())/1e3,d=Math.floor(c/86400);if(isNaN(d)||d<0||d>=31)return;return d==0&&(c<60&&"A few seconds ago"||c<120&&"1 minute ago"||c<3600&&Math.floor(c/60)+" minutes ago"||c<7200&&"1 hour ago"||c<86400&&Math.floor(c/3600)+" hours ago")||d==1&&"Yesterday"||d<7&&d+" days ago"||d<31&&Math.ceil(d/7)+" weeks ago"}if(typeof jQuery!="undefined")jQuery.fn.prettyDate=function(){return this.each(function(){var a=prettyDate(this.title);if(a)jQuery(this).text(a)})};TwitterSearch.prototype={search:function(a,b,c,d){var e=this;var f=new TwitterSearchRequest(a,b,c,d);e.requestQueue.push(f);e.process()},process:function(){var a=this;if(a.processTimeout){clearTimeout(a.processTimeout);a.processTimeout=null}if(a.canSearchAgain()&&a.requestQueue.length>0){a.requestQueue.shift().execute();a.lastSearchTime=(new Date).getTime();a.timeoutLength=a.rateLimitSecs*1e3}else{var b=a.lastSearchTime-(new Date).getTime()+a.rateLimitSecs*1e3;b+=250}if(a.requestQueue.length>0){a.processTimeout=setTimeout(function(){a.process()},b)}},canSearchAgain:function(){var a=this;if(a.lastSearchTime==null){return true}return(new Date).getTime()-a.rateLimitSecs*1e3>=a.lastSearchTime}};TwitterSearchRequest.prototype={execute:function(){var a=this;var b={q:a.search,rpp:50};if(a.options.sinceId){b.since_id=a.options.sinceId}if(a.options.maxId){b.max_id=a.options.maxId}$.ajax({url:"http://search.twitter.com/search.json",data:b,dataType:"jsonp",success:function(b){clearTimeout(a.failureTimeout);if(b.results){a.successCallback(b)}else{a.errorCallback(b)}}});a.failureTimeout=setTimeout(function(){a.failureCallback()},7e3)}};Tweet.prototype={getNode:function(){var a=this;if(a.$node!=null){return a.$node}var b=$('<div class="TwitterSearchFeed_tweet"></div>');var c=$('<a class="TwitterSearchFeed_tweet_profileImage"></a>').attr("href","http://twitter.com/"+a.data.from_user).attr("target","_blank").append($("<img />").attr("src",a.data.profile_image_url)).appendTo(b);var d=$('<div class="TwitterSearchFeed_tweet_content"></div>').appendTo(b);b.append('<div class="TwitterSearchFeed_tweet_clear"></div>');$('<a class="TwitterSearchFeed_tweet_user"></a>').attr("href","http://twitter.com/"+a.data.from_user).attr("target","_blank").text(a.data.from_user).appendTo(d);$('<span class="TwitterSearchFeed_tweet_text"></span>').html(a.parseTweetText(a.data.text)).appendTo(d);var e=new Date(a.data.created_at);var f=e.getFullYear();var g=e.getMonth()+1;var h=e.getDate();var i=e.getHours();var j=e.getMinutes();if(j<10){j="0"+j}var k=i>11?"pm":"am";if(i>12){i=i-12}if(i==0){i=12}var l=g+"/"+h+"/"+f+" "+i+":"+j+" "+k;$('<div class="TwitterSearchFeed_tweet_time"></div>').attr("title",a.data.created_at).text(l).prettyDate().appendTo(d);return b},parseTweetText:function(a){a+=" ";a=a.replace(/(https?\:\/\/\S+)(\s)/gi,function(){var a=arguments[1];var b=arguments[2];return'<a href="'+a+'" target="_blank">'+a+"</a>"+b});a=a.replace(/@(\w+)(\W)/gi,function(){var a=arguments[1];var b=arguments[2];return'<a href="http://twitter.com/'+a+'" target="_blank">@'+a+"</a>"+b});return a}};Tweet.constructArray=function(a,b){var c=[];$.each(b,function(){c.push(new Tweet(a,this))});return c};FeedView.prototype={construct:function(){var a=this;a.$node.addClass("TwitterSearchFeed");a.$fade=$('<div class="TwitterSearchFeed_fade"></div>').appendTo(a.$node);a.$viewport=$('<div class="TwitterSearchFeed_viewport"></div>').appendTo(a.$node);a.$viewport.css("height",a.options.viewportHeight);a.$feed=$('<div class="TwitterSearchFeed_feed"></div>').appendTo(a.$viewport)},destroy:function(){var a=this;a.$fade.remove();a.$viewport.remove();a.$node.removeClass("TwitterSearchFeed")},isRunningOut:function(){var a=this;return a.$viewport.scrollTop()>a.$feed.height()-3*a.options.viewportHeight},displayAtTop:function(a,b){var c=this;var d=$('<div class="TwitterSearchFeed_tweet_transport"></div>');$.each(a,function(){var a=this;$node=a.getNode();d.prepend($node)});c.$feed.prepend(d);var e=d.height();var f=c.$viewport.scrollTop();if(f==0){d.css("margin-top",0-e).show();d.animate({"margin-top":0},400,"swing",function(){d.children().prependTo(d.parent());d.remove()})}else{c.$feed.prepend(d);d.show();c.$viewport.scrollTop(f+e);d.children().prependTo(d.parent());d.remove()}},displayAtBottom:function(a){var b=this;$.each(a,function(){var a=this;$node=a.getNode();b.$feed.append($node)})},prettifyTweetTimes:function(){var a=this;a.$feed.find(".TwitterSearchFeed_tweet_time").prettyDate()}};FeedBuffer.prototype={set:function(a){var b=this;b.stop();b.tweets=a;if(b.tweets.length>b.maxTweets){b.processRateSecs=b.options.minDelaySecs;var c=b.tweets.splice(0,b.tweets.length-b.maxTweets);b.parent.view.displayAtTop(c,"slide");b.timeout=setTimeout(function(){b.process()},b.processRateSecs*1e3)}else{b.processRateSecs=b.options.updateSecs/b.tweets.length;b.process()}},stop:function(){var a=this;if(a.timeout){clearTimeout(a.timeout)}if(a.tweets.length>0){a.parent.view.displayAtTop(a.tweets,"slide");a.tweets=[]}},process:function(){var a=this;var b=a.tweets.shift();if(b==null){return}a.parent.view.displayAtTop([b],"slide");a.timeout=setTimeout(function(){a.process()},a.processRateSecs*1e3)}};Feed.prototype={init:function(){var a=this;a.checkPrefetch(function(){a.update()});a.view.$viewport.bind("scroll",function(){a.checkPrefetch()})},update:function(){var a=this;var b={sinceId:a.searchSinceId};var c=function(b){if(b.results.length>0){a.searchSinceId=b.results[0].id_str}a.buffer.set(Tweet.constructArray(a,b.results));a.view.prettifyTweetTimes();a.parent.clearStatus()};var d=function(b){a.parent.setStatus("error","We could not communicate with Twitter Search. Perhaps it is down? We will keep trying.")};a.parent.setStatus("loading");a.api.search(a.options.search,c,d,b);a.updateTimeout=setTimeout(function(){a.update()},a.options.updateSecs*1e3)},checkPrefetch:function(a){var b=this;if(b.reachedBottom||b.searchInProgress||!b.view.isRunningOut()){return}b.searchInProgress=true;var c=function(c){if(c.results.length>0){if(!b.searchSinceId){b.searchSinceId=c.results[0].id_str}b.searchMaxId=c.results[c.results.length-1].id_str;b.view.displayAtBottom(Tweet.constructArray(b,c.results))}else{b.reachedBottom=true}if(a!=null){a(c)}b.searchInProgress=false;b.parent.clearStatus()};var d=function(){if(a!=null){a()}b.searchInProgress=false;b.parent.setStatus("error","We could not communicate with Twitter Search. Perhaps it is down? We will keep trying.")};b.parent.setStatus("loading");var e={maxId:b.searchMaxId};b.api.search(b.options.search,c,d,e)},destroy:function(){var a=this;clearTimeout(a.updateTimeout);a.view.destroy()}};TwitterSearchFeed.prototype={setStatus:function(a,b){var c=this;switch(a){case"error":c.$status.html('<div class="TwitterSearchFeed_error">'+b+"</div>");break;case"loading":c.$status.html('<img src="images/spinner.gif" />');break}},clearStatus:function(){var a=this;a.$status.children().remove()},destroy:function(){var a=this;a.feed.destroy()}}